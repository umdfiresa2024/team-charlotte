---
title: "GeoCoding"
format: gfm
editor: visual
---

## GeoCoding

This script leverages the Google Maps Geocoding API to retrieve the latitude and longitude coordinates for each station on the Charlotte Light Rail Blue Line. The retrieved coordinates are then used to create a plot, effectively visualizing the spatial distribution of the stations.

## Running Code

### Installing Packages

```{r}
#| echo: false
install.packages("tidyverse")
install.packages("ggmap")
install.packages("maptiles")
install.packages("terra")
install.packages("leaflet")
install.packages("lubridate")
```

### Loading Libraries

```{r}
#| echo: false
library("tidyverse")
library("ggmap")
library("terra")
library("maptiles")
library("leaflet")
library("lubridate")
library("dplyr")
```

### Fetching the Coordinates

Using Google API

```{r}
# DONT RUN THIS CODE
c<-read.csv("FinalLightBlueDataset.csv")
c


register_google(key = "AIzaSyBFzZRvnnrYw2l5CQRrbBnPZt2-EIAsiD8", write = TRUE)

#dir()

addr.geo <- mutate_geocode(c, location = stations, output = "latlona")

```

### Transferring Data into CSV File

```{r}
# DONT RUN THIS CODE
write.csv(addr.geo, "geocoded_data.csv", row.names = FALSE)
```

### Cleaning Data

```{r}
addrs.geo <- read.csv("geocoded_data.csv")
new_addr <- addrs.geo %>% 
  mutate(
    lat2 = ifelse(
      stations == "Bland Street station", 
      35.21622, 
      lat
    ), 
    lon2 = ifelse(
      stations == "Bland Street station", 
      -80.85446, 
      lon
    ),
    address2 = ifelse(
      stations == "Bland Street station", 
      "1511 Camden Road, charlotte, nc, usa", address
      
    )
  ) %>% 
  mutate(
    lat2 = ifelse(
      stations == "Carson light rail station (Charlotte)", 
      35.21944, 
      lat2
    ), 
    lon2 = ifelse(
      stations == "Carson light rail station (Charlotte)", 
      -80.84823, 
      lon2
    ),
    address2 = ifelse(
      stations == "Carson light rail station (Charlotte)", 
      "218 East Carson Boulevard, charlotte, nc, usa",
      address2
    )
  ) %>% 
  mutate(
    lat2 = ifelse(
      stations == "Charlotte Transportation Center", 
      35.21944, 
      lat2
    ), 
    lon2 = ifelse(
      stations == "Charlotte Transportation Center", 
      -80.84823, 
      lon2
    ),
    address2 = ifelse(
      stations == "Charlotte Transportation Center", 
      "310 East Trade Street, charlotte, nc, usa", address2 
    )
  ) %>% 
  
  
  mutate(
    lat2 = ifelse(
      stations == "JW Clay Blvd/UNC Charlotte station", 
      35.31155, 
      lat2
    ), 
    lon2 = ifelse(
      stations == "JW Clay Blvd/UNC Charlotte station", 
      -80.74547, 
      lon2
    ),
    address2 = ifelse(
      stations == "JW Clay Blvd/UNC Charlotte station", 
      "9048 North Tryon Street, charlotte, nc, usa", address2 
    )
  )


```

```{r}
write.csv(new_addr, "new_station_coords_data.csv", row.names = FALSE)
```

### Storing Lat-lon

```{r}
sample_latlon <- cbind(new_addr$lon2, new_addr$lat2)
sample_latlon
```

### Using Vector Data

```{r}
pts <-  vect(sample_latlon)
class(pts)
pts
geom(pts)
crdref <- "+proj=longlat +datum=WGS84"
pts <- vect(sample_latlon, crs=crdref)
plot(pts)
crs(pts)
```

### Coordinate Reference System(CRS)

```{r}
#crdref <- "+proj=longlat +datum=WGS84"
#pts1 <- vect(sample_latlon, crs=crdref)
#plot(pts1)
#crs(pts1)
```

### Plotting the Coordinates

```{r}
point_map <- vect(sample_latlon, type="points", crs = crdref)
point_map
plot(point_map)
pols <- vect(sample_latlon, type="polygons", crs = crdref)
pols
plot(pols)
plot(pols, border="blue", col="yellow", lwd=2)
# pch = plot charater = 20 - circle 
# cex = charater expansion
points(x = pts, col="red", pch = 20, cex = 1)

```

### Overlaying the Map

```{r}
x <- vect(sample_latlon, crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
plot(x)
pm_sources <- vect("/Users/paditya9/teamCharlotte/PM2.5 ShapeFiles/new_pm_coords_sources.shp")
plot(pm_sources)

# Creating Buffer around stations

# Ued Buffer Radius is 800 meters
pts_buffer <- buffer(x, width = 800)
plot(pts_buffer)

# Creating Buffer for Map
extent<-buffer(x, width = 200)

bg <- get_tiles(ext(extent), zoom = 11)

plot(bg)

# pch=19 gives filled circles
points(x, col="blue", pch=19, cex=0.5)

# pch=17 gives filled triangles
points(pm_sources, col="purple", pch=17, cex=1)

# Plot the buffer around the stations
lines(pts_buffer, col="red")
```

### Saving Buffer Radius as Shape File

```{r}
writeVector(pts_buffer, "new_buffer_light_rail.shp")
```

### Interactive Map

```{r}
bg <- get_tiles(ext(extent))
points <- x
#lines_lr <- lr_project
#lines_buffer1 <- pts_buffer1
lines_buffer2 <- pts_buffer

interactive_map <- leaflet() %>%
  addTiles() %>%
  addMarkers(data = points) %>%
  #addPolylines(data = lines_lr, color = "blue") %>%
  #addPolylines(data = lines_buffer1, color = "green") %>%
  addPolylines(data = lines_buffer2, color = "red") %>%
  addCircleMarkers(data = pm_sources)
interactive_map
```

```{r}
dir()
```

### Combining PM_25 Daily Data

```{r}
# List all CSV files in the directory
file_list <- list.files(path = "PM25_daily", pattern = "*.csv", full.names = TRUE)

# Read and combine all CSV files into one data frame
combined_df <- do.call(rbind, lapply(file_list, function(file) {
  df <- read.csv(file)
  # Assuming your date column is named 'date' and is in format '%Y%m%d'
  df$date <- as.Date(df$date, format = "%Y%m%d")
  df
}))

# Filter rows from 2003-11-24 to 2011-11-24
combined_df_filtered <- combined_df %>%
  filter(date >= as.Date("2003-11-24") & date <= as.Date("2011-11-24"))

# Write the filtered data frame to a new CSV file
write.csv(combined_df_filtered, "refined_PM25_daily_combined_data.csv", row.names = FALSE)

PM_25_with_date <- read.csv("refined_PM25_daily_combined_data.csv")

PM_25_with_date <- PM_25_with_date %>%
   mutate(formatted_date = paste(substr(date, 1, 4), substr(date, 6, 7), substr(date, 9, 10), sep = "-")) %>% mutate(station_ID = PM_25_with_date$city_num )

write.csv(PM_25_with_date, "refined_date_PM25_daily_data.csv")

```

### Creating Station ID

```{r}
stations_coords <- read.csv("/Users/paditya9/teamCharlotte/new_station_coords_data.csv")

stations_coords <- stations_coords %>% mutate(station_ID = row_number())

write.csv(stations_coords, "station_coords_with_stationID_data.csv", row.names = F)
```

### Cleaning Holiday Data file

```{r}
holidays_data <- read.csv("/Users/paditya9/teamCharlotte/major_holidays_2000_2025.csv", header = TRUE, stringsAsFactors = FALSE)

holidays_data <- holidays_data %>% filter(date >= as.Date("2003-11-24") & date <= as.Date("2011-11-24")) %>% mutate(formatted_date = date)

write.csv(holidays_data, "refined_holidays_data.csv", row.names = F)
```

### Cumulative Date

```{r}
#Reading Stations Data
stationID_data <- read.csv("station_coords_with_stationID_data.csv", header = TRUE, stringsAsFactors = FALSE)[, c("stations", "station_ID", "address2")]

#Reading PM2.5 Daily Data
pm_25_data <- read.csv("refined_date_PM25_daily_data.csv", header = TRUE, stringsAsFactors = FALSE)[, c("station_ID", "formatted_date", "pm25")]

#Reading Meterological Data
met_data <- read.csv("met_data_charlotte/combinedMeteorologyDataCharlotte.csv", header = TRUE, stringsAsFactors = FALSE)[, c("Tair_f_tavg", "Wind_f_tavg", "Qair_f_tavg", "formatted_date")]

#Reading Holiday Data
holidays_data <- read.csv("/Users/paditya9/teamCharlotte/refined_holidays_data.csv", header = TRUE, stringsAsFactors = FALSE)[, c("holiday", "formatted_date")]

station_pm_met_dataCombined <- merge(stationID_data,pm_25_data, by="station_ID", all = F )

station_pm_met_dataCombined <- merge(station_pm_met_dataCombined, met_data, by="formatted_date", all = F)

# Check code, 
# station_pm_met_dataCombined rows â‰  station_pm_met_holiday_dataCombined
station_pm_met_holiday_dataCombined <- station_pm_met_dataCombined %>%
  left_join(holidays_data, by = "formatted_date")


# Ordering the list by date followed by station ID
station_pm_met_holiday_dataCombined <- station_pm_met_holiday_dataCombined[order(station_pm_met_holiday_dataCombined$formatted_date, station_pm_met_holiday_dataCombined$station_ID), ]

# %B is used for abbrevation for Month 
station_pm_met_holiday_dataCombined <- station_pm_met_holiday_dataCombined %>%
  mutate(month = format(as.Date(station_pm_met_holiday_dataCombined$formatted_date, format = "%Y-%m-%d"), "%B")) %>% 
  mutate (day_of_week = weekdays(as.Date(station_pm_met_holiday_dataCombined$formatted_date, format = "%Y-%m-%d")))

# summary(station_pm_met_holiday_dataCombined)




```
